
# 高度なグルーピングロジック実装仕様（最新版）

## 概要

カテゴリ情報とフリーテキスト情報を組み合わせ、総合的な評価に基づいて最適なグループを形成するためのシステム実装仕様です。Azure OpenAI ServiceのEmbeddingモデルと、柔軟なルール設定に基づいたスコアリングを特徴とします。

## 実装する主要関数

### 1. `create_advanced_similarity_matrix()`

* **目的** : 全メンバー間のテキスト類似度行列を作成します。
* **処理** :
* **テキスト準備** : UIで選択されたテキスト列（単一または2列）をメンバーごとに結合します。2列の場合は `[SEP]` で区切ります。
* **ベクトル化** : Azure OpenAIのEmbeddingモデル（`get_embeddings_batch`経由）で、準備したテキストをベクトルに変換します。APIエラー時はTF-IDFにフォールバックします。
* **行列生成** : 全ベクトルのペアでコサイン類似度を計算し、N×Nの類似度行列を生成します。
* **戻り値** : `similarity_matrix` (numpy array)

### 2. `calculate_advanced_group_score()`

* **目的** : 指定されたメンバーで構成されるグループの総合スコアを計算します。
* **処理** :
* **カテゴリマッチングスコア** : 設定された優先度（7,5,3,1点）と戦略（多様性/同質性）に基づき、カテゴリごとの点数を計算します。
  *  **満点** : 戦略の条件（全員一致/全員不一致）を完全に満たす場合。
  *  **部分点** : 条件（過半数が一致/不一致）を部分的に満たす場合に点数の半分を加算。
* **テキスト類似度スコア** : グループ内の全ペアの類似度（`similarity_matrix`から取得）を合計します。
* **総合スコア** : `(カテゴリマッチングスコア) + (テキスト類似度スコア × w_sim)` で算出します。
* **戻り値** : `score` (float)

### 3. `find_advanced_optimal_groups()`

* **目的** : 反復最適化により、メンバー全体を最適なグループに分割します。
* **処理** :

1. **希望サイズでの最適化** : 残りメンバーが「希望グループサイズ」以上いる間、そのサイズで最もスコアが高いグループの作成を繰り返します。
2. **端数処理** : 残ったメンバー数が「希望グループサイズ - 1」（ただし最小2人）以上の場合、そのメンバーで1つのグループを作成します。
3. **最終割り当て** : それでも残った少数のメンバーを、スコアが最も向上する既存グループに追加します。（`assign_remaining_members_advanced`を呼び出し）

* **戻り値** : `final_groups` (list of group dicts)

### 4. `assign_remaining_members_advanced()`

* **目的** : グループ分けで残った少数のメンバーを、既存のグループに最適に割り当てます。
* **処理** :
* 各残存メンバーについて、どの既存グループに追加すれば最もスコアが向上するかを計算します。
* スコアの増分が最大となるグループにメンバーを追加し、グループ情報を更新します。
* **戻り値** : なし（引数で受け取った `groups` リストを直接更新します）

### 5. `display_advanced_group_analysis()`

* **目的** : グルーピング結果の分析サマリーをUIに表示します。
* **処理** :
* 全体の統計情報（総グループ数、平均サイズなど）を表示します。
* 各グループについて、メンバー構成、スコア、カテゴリ別の分析（設定した戦略と実際の分布）を詳細に表示します。
* **戻り値** : なし（UIへの出力のみ）

## パラメータ設定

### UIでユーザーが設定する項目

* **希望グループサイズ** : グループを作成する際の基本人数。（例: 4人）
* **テキスト類似度の重み (`w_sim`)** : テキスト類似度スコアの重要度を調整する係数。（整数: 0〜10）
* **カテゴリ戦略** : 3つのカテゴリそれぞれに「多様性重視」または「同質性重視」を設定。
* **カテゴリ優先度** : 3つのカテゴリに優先順位を設定（1位:7点, 2位:5点, 3位:3点, 4位:1点）。

## 高度グルーピングの全体フロー

### Phase 1: 準備

1. **UI設定取得** : ユーザーが設定した「希望グループサイズ」「類似度の重み」「各カテゴリの戦略」などを取得します。
2. **類似度行列作成** : `create_advanced_similarity_matrix()` を実行し、全メンバー間のテキスト類似度を事前計算します。
3. **戦略・優先度マッピング** : UI設定をスコア計算で利用できる形式（辞書など）に変換します。

### Phase 2: 反復最適化 (`find_advanced_optimal_groups`)

1. **初期化** : `available_indices`（未割り当てメンバーのリスト）、`final_groups`（確定したグループのリスト）を準備します。
2. **メインループ** : `available_indices` が「希望グループサイズ」以上の間、以下を繰り返します。

* 未割り当てメンバーの中から、最もスコアが高い「希望グループサイズ」の組み合わせを探します。（計算負荷のため、探索対象はランダムサンプリングされる）
* 最高スコアのグループを `final_groups` に追加し、そのメンバーを `available_indices` から削除します。

### Phase 3: 残存メンバー処理

1. **端数グループ作成** : メインループ終了後、`available_indices` に「希望グループサイズ - 1」以上のメンバーが残っている場合、その全員で1つのグループを作成します。
2. **個別割り当て** : それでも残ったメンバー（1人など）がいる場合、`assign_remaining_members_advanced()` を呼び出し、既存グループに1人ずつ追加していきます。

### Phase 4: 結果表示

1. **分析と表示** : `display_advanced_group_analysis()` を実行し、最終的なグループ構成と各種分析結果をUIに描画します。
2. **CSV出力** : 最終結果をまとめたDataFrameを生成し、ダウンロードボタンを提供します。

## 実装の考慮事項

* **パフォーマンス** : メンバー数が100人を超える場合でも、組み合わせ探索のサンプリング（最大40人から探索）により、現実的な時間で処理を完了させます。
* **エラーハンドリング** : Azure OpenAI APIへの接続に失敗した場合、自動的にTF-IDFによる計算に切り替わるフォールバック機構を備えます。
* **ユーザビリティ** : 処理の進捗状況（「〜人グループを探索中」「端数処理中」など）をリアルタイムで表示し、ユーザーが待機時間を不安に感じないように配慮します。
