高度グルーピングツール

## 概要 📝

本ツールは、複数のカテゴリ情報とフリーテキスト情報を持つユーザーデータを、**カテゴリの組み合わせ**と**テキスト内容の類似度**という2つの軸を総合的に評価し、最適なグループに分割するStreamlitアプリケーションです。Azure OpenAI ServiceのEmbeddingモデルを活用し、より人間的な感覚に近いグループ分けを実現します。

## 主な機能 🚀

* **Excelファイル対応** : ユーザーデータをExcelファイルから簡単にアップロードできます。
* **自動列タイプ判定** : アップロードされたデータの各列が「タグ系」か「フリーテキスト」かを自動で分析・判定します。
* **カテゴリのグループ化** : タグ系の列（例：部署、役職）について、値を任意にグルーピングできます。
* **柔軟なスコアリング戦略** :
* **カテゴリ戦略** : 各カテゴリに対して「 **多様性** （メンバーが異なる方が高得点）」と「 **同質性** （メンバーが同じ方が高得点）」の戦略を選択できます。
* **優先度設定** : カテゴリの重要度に応じて、スコアの配点（7, 5, 3, 1点）を自由に設定できます。
* **部分点評価** : カテゴリが完全に一致・不一致でなくても、「過半数が同じ/異なる」場合に部分点が与えられます。
* **テキスト類似度分析** :
* Azure OpenAIの**Embeddingモデル**を利用して、フリーテキスト（例：スキル、自己PR）の意味的な類似度を計算します。
* **複数列の結合分析**にも対応しており、より多角的なプロフィール情報から類似度を評価できます。
* 類似度の**重み**をスライダーで調整し、グルーピングへの影響度を変更できます。
* **最適なグループ分割** :
* 設定された希望グループサイズを基本とし、最適なスコアの組み合わせを探索してグループを作成します。
* 端数が出た場合は、残りのメンバーでグループを再構成したり、既存のグループに最適に割り当てたりするロジックを搭載しています。
* **結果の可視化と出力** :
* 作成されたグループの詳細な分析結果を画面に表示します。
* 最終的なグループ分けの結果を**CSVファイル**としてダウンロードできます。

## 使用方法 🛠️

#### 1. 環境設定

* プロジェクトのルートに `.env.local` ファイルを作成し、以下の内容を記述します。
  ```
  ENDPOINT="YOUR_AZURE_OPENAI_ENDPOINT"
  API_KEY="YOUR_AZURE_OPENAI_API_KEY"

  ```
* 必要なパッケージをインストールします。
  ```
  pip install -r requirements.txt

  ```

#### 2. アプリケーションの起動

* ターミナルで以下のコマンドを実行します。
  ```
  streamlit run main.py

  ```

#### 3. Webインターフェースでの操作

1. **Excelファイルアップロード** : ユーザー情報が記載されたExcelファイルをアップロードします。
2. **列タイプ確認** : 自動判定された列タイプを確認し、必要に応じてテキスト類似度分析に使う列を手動で選択します。
3. **カテゴリ設定** :

* 各カテゴリの値を任意にグルーピングします。
* カテゴリごとに「多様性」か「同質性」の戦略を選択します。
* カテゴリの優先順位と点数を設定します。

1. **高度グルーピング設定** :

* テキスト類似度を計算する列（単一または2列結合）を選択します。
* テキスト類似度の重みをスライダーで調整します。
* 希望するグループサイズを入力します。

1. **実行** : 「高度グルーピング実行」ボタンをクリックすると、処理が開始され、結果が表示されます。

## 動作原理 ⚙️

本ツールは、各グループ候補に対して以下の2つのスコアを算出し、その合計値が最大となるような組み合わせを探索します。

1. **カテゴリマッチングスコア** :

* ユーザーが設定した **優先順位** （7, 5, 3, 1点）と **戦略** （多様性/同質性）に基づき計算されます。
* 例えば「多様性」戦略の場合、グループ内のメンバーのカテゴリが全員異なれば満点、過半数が異なれば半分の点数が与えられます。

1. **テキスト類似度スコア** :

* 選択されたテキスト列（複数可）の内容をAzure OpenAIで**ベクトル化（Embedding）**します。
* グループ内の全ペアの**コサイン類似度**を合計します。メンバー同士のテキスト内容が似ているほど、このスコアは高くなります。

**最終スコア = (カテゴリマッチングスコア) + (テキスト類似度スコア) × (重み)**

この最終スコアを指標として、指定されたグループサイズを維持しながら、全体のスコアが最も高くなるようにメンバーを割り当てていきます。

## 必要なパッケージ 📦

* streamlit
* pandas
* numpy
* openai
* scikit-learn
* python-dotenv
* openpyxl

完全なリストは `requirements.txt` を参照してください。
